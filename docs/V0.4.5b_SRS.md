EvoNote V0.4.5b 软件需求规格说明书 (SRS)
版本：V0.4.5b — 常用按键工具栏与核心体验修复
目标：在V0.4.5a基础上，新增可拖拽排序的常用按键工具栏与导航历史服务，并修复Shift+点击弹窗、编辑器标题与重命名、库管理约束、内容块输入稳定性问题，提升稳定性与可用性。
决策：采用选项A（QToolBar作为“常用按键”容器；历史仅记录主窗口跳转；Shift+点击改为浮动QDockWidget；全库重命名同步；持久化工具栏与历史参数）。

一、范围与术语
- 主窗口：EvoNote的QMainWindow容器。[MainWindow](core/app.py:56)
- 编辑器：ReactiveEditor停靠于QDockWidget的实例。[ReactiveEditor](plugins/editable_editor/main.py:15)
- 全局信号总线：[GlobalSignalBus](core/signals.py:86)
- 索引服务：文件与内容块索引服务。[FileIndexerService](services/file_indexer_service.py:20)
- 历史服务：新增导航历史记录器，维护跳转栈与指针。

二、功能需求 FR
FR-1 常用按键工具栏与导航历史
FR-1.1 UI与容器
- 新增导航工具栏插件，提供QToolBar，标题显示为“导航”。
- 工具栏包含两个核心按钮：后退与前进。
- 工具栏允许停靠于主窗口顶部或左侧；支持用户拖拽重排按钮顺序并持久化。
- 插件加载后由UI管理器加入主窗口停靠区。[UIManager.add_dock_widget](core/app.py:478)

FR-1.2 导航历史服务
- 在服务层新增NavigationHistoryService，维护历史列表与当前指针；最大长度可配置（nav_history_maxlen）。
- 入栈规则：仅当[GlobalSignalBus.page_navigation_requested](core/signals.py:31)被成功处理并广播[GlobalSignalBus.active_page_changed](core/signals.py:48)后，才将目标页面加入历史。
- 排除项：不记录Shift+点击触发的[GlobalSignalBus.page_open_requested](core/signals.py:39)，不记录程序性初始广播（例如[GlobalSignalBus.active_page_changed](core/signals.py:48)在启动时的Note A.md）。
- 提供服务方法：back()、forward()、push(page_path)、state()返回是否可后退/前进及当前项。
- 定义新信号：nav_history_state_changed，携带可后退、可前进与当前项信息。[GlobalSignalBus.nav_history_state_changed](core/signals.py:86)

FR-1.3 按钮逻辑
- 工具栏的后退/前进按钮分别发出back_navigation_requested与forward_navigation_requested信号。[GlobalSignalBus.back_navigation_requested](core/signals.py:86) [GlobalSignalBus.forward_navigation_requested](core/signals.py:86)
- EvoNoteApp订阅这两个信号并调用历史服务的back()/forward()，随后驱动[GlobalSignalBus.page_navigation_requested](core/signals.py:31)完成跳转与入栈。
- 当历史服务报告不可后退或不可前进时，相应按钮setEnabled(False)，否则为True。

FR-2 窗口与编辑器修复
FR-2.1 Shift+点击行为修复为浮动Dock
- 将[Shift+点击处理路径](plugins/editable_editor/main.py:699)由打开独立QMainWindow的[EvoNoteApp._open_note_window](core/app.py:325)改为创建QDockWidget。
- 新Dock默认在主界面内以浮动状态弹出，可拖回停靠区；标题为笔记名的stem（不含.md）。
- 该Dock内嵌新的ReactiveEditor实例，注入app_context、db_path，连接保存与索引信号，确保输入内容被保存并参与索引。

FR-2.2 编辑器Dock标题显示当前笔记
- 在[ReactiveEditor.on_active_page_changed](plugins/editable_editor/main.py:140)加载完成后，获取父QDockWidget并调用setWindowTitle为当前笔记stem。
- 在focusIn事件中仍广播[GlobalSignalBus.active_page_changed](core/signals.py:48)，但不修改历史。

FR-2.3 笔记重命名与引用同步
- 为编辑器Dock标题栏增加双击重命名交互：进入QLineEdit编辑态，按Enter确认。
- 提交rename_file任务到索引服务队列。[FileIndexerService.task_queue](services/file_indexer_service.py:28)
- 索引服务处理：a) 重命名磁盘上的.md文件；b) 事务性更新SQLite中的files与links（复用[_handle_move](services/file_indexer_service.py:407)逻辑）；c) 全库将[[旧名]]替换为[[新名]]并原子写入；d) 更新Whoosh索引；e) 为受影响文件投递upsert。
- 冲突与校验：若新名已存在或不合法（空名、含路径分隔），拒绝并提示；允许仅在pages目录内重命名。

FR-3 核心逻辑修复
FR-3.1 库管理约束
- 当前激活库不可被移除；在库管理界面中为当前库的删除按钮置灰禁用，并在配置层拒绝remove当前库（防御式编程）。
- 当库切换时广播[GlobalSignalBus.vault_state_changed](core/signals.py:77)，UI联动调整禁用态。

FR-3.2 内容块输入稳定性
- 加固[ReactiveEditor._check_for_completion_trigger](plugins/editable_editor/main.py:259)的边界检查：
  1) 对正则匹配结果进行长度与索引校验，任何异常都不得影响文档内容；
  2) 在所有完成弹窗路径上增加try保护与状态复位，确保失败仅隐藏补全，不清空文档；
  3) 对输入“{{”“{{12”等快速触发场景执行防抖与异常吞噬；
- 增加单测：模拟多轮快速输入，断言编辑器内容不被清空，且completion弹窗行为仅关闭不会影响文本。

三、非功能需求 NFR
- 原子写：文件写入使用[_atomic_write](services/file_indexer_service.py:499)确保数据一致性与耐崩溃性。
- 性能：历史服务操作O(1)；补全UI使用80ms去抖与惰性渲染。[ReactiveEditor._schedule_render_update](plugins/editable_editor/main.py:592)
- 可靠性：所有信号订阅与保存路径加入异常保护，不传播到UI线程致崩溃。
- 可配置性：新增配置键toolbar_actions、nav_history_maxlen；工具栏位置与排序持久化。

四、数据与配置
- 配置键新增：
  - toolbar_actions: 工具栏按钮顺序，如["back","forward","..."]。
  - nav_history_maxlen: 历史最大长度，默认50。
- SQLite表维持不变；重命名与块同步通过现有files、links、blocks、block_instances与FTS触发器完成。

五、接口与信号
- 新增信号：
  - back_navigation_requested：用户点击后退时发出。[GlobalSignalBus.back_navigation_requested](core/signals.py:86)
  - forward_navigation_requested：用户点击前进时发出。[GlobalSignalBus.forward_navigation_requested](core/signals.py:86)
  - nav_history_state_changed：历史服务广播按钮使能与当前项。[GlobalSignalBus.nav_history_state_changed](core/signals.py:86)
- 现有信号沿用：
  - [GlobalSignalBus.page_navigation_requested](core/signals.py:31)
  - [GlobalSignalBus.page_open_requested](core/signals.py:39)
  - [GlobalSignalBus.active_page_changed](core/signals.py:48)
  - [GlobalSignalBus.vault_state_changed](core/signals.py:77)

六、实现计划与影响范围
- 新增：services/navigation_history_service.py（独立服务类与状态管理）。
- 修改：core/signals.py（新增三个导航相关信号占位）。
- 修改：core/app.py
  - 在[EvoNoteApp.on_page_navigation_requested](core/app.py:271)成功路由后push历史并广播nav_history_state_changed。
  - 订阅back_navigation_requested与forward_navigation_requested，驱动历史服务与导航。
  - 更新[_open_note_window](core/app.py:325)为创建浮动QDockWidget版本。
- 新增：plugins/navigation_toolbar.py（QToolBar插件，拖拽排序、配置持久化与使能联动）。
- 修改：plugins/editable_editor/main.py
  - 在[on_active_page_changed](plugins/editable_editor/main.py:140)后更新父Dock标题。
  - 增加标题重命名UI与提交rename_file任务。
  - 加固[_check_for_completion_trigger](plugins/editable_editor/main.py:259)。
- 修改：services/file_indexer_service.py
  - 新增rename_file任务分支，复用[_handle_move](services/file_indexer_service.py:407)并执行全库引用替换与upsert。

七、验收标准
开发者验收
- 导航栏：后退/前进按钮随历史可用性联动；历史push与指针移动正确；边界禁用正确。
- 新窗口：Shift+点击创建的是QDockWidget实例，能回停靠，内部编辑器能保存内容且索引更新。
- 标题与重命名：Dock标题显示当前笔记名；重命名后磁盘文件更新、数据库与Whoosh同步、全库[[旧名]]更新。
- 库管理：当前库的移除按钮为不可用；配置层拒绝移除当前库。
- 内容块：单测覆盖{{12、{{等场景，任何情况下文档不被清空。

用户验收 UAT
- 导航：打开Note A、Note B、Another Note C；后退至B、再后退至A（按钮禁用）；前进至B。
- Shift+点击：在Note A中Shift+点击[[Note B]]，弹出浮动Dock“Note B”，拖入右侧停靠；在该Dock内输入内容，切换其他笔记后返回，内容未丢失。
- 标题与重命名：点击[[Note A]]后Dock标题为“Note A”；双击标题改为“Note A Renamed”，后台开始更新所有[[Note A]]引用。
- 库管理：当前库的x按钮不可用。
- 内容块：在空白笔记中反复快速输入{{12与{{，笔记内容保持不变。

八、风险与缓解
- Windows文件锁：重命名与Whoosh更新需串行事务；发生锁失败时重试或提示。
- 重命名冲突：新名已存在时拒绝并提示，保持索引一致。
- 历史一致性：程序性广播不入栈，避免误导前进后退语义；必要时以标志位屏蔽。
- UI拖拽排序复杂性：优先使用QToolBar actions的内置移动事件，必要时自定义DND并集中持久化。

九、测试计划
- 单元测试：内容块稳定、历史服务push/pop边界、重命名合法性校验。
- 集成测试：rename_file对files、links、block_instances与FTS触发器的联动。
- 手工UAT：按第七章执行。

十、发布与迁移
- 版本号更新：[VERSION](core/app.py:24)从0.4.5a改为0.4.5b。
- 文档更新：README与acceptance_plan同步新增导航与重命名说明。
- 兼容性：沿用现有配置结构，新增键有默认值，不影响既有用户。

十一、实施里程碑
- 里程碑1：信号与服务骨架完成，工具栏可用，历史联动生效。
- 里程碑2：Shift+点击浮动Dock与编辑器标题更新上线。
- 里程碑3：重命名任务与全库引用同步上线，完成单测。
- 里程碑4：库管理修复与UAT通过，发布V0.4.5b。