# EvoNote V1.0 - 最终架构方案：回归本源

---
## **致高层AI的执行摘要 (Executive Summary)**

**1. 遇到的问题 (The Problem):**
我们在尝试构建一个自定义的Markdown编辑器时，遇到了无法根除的底层输入问题（如Tab键、光标错位等）。经过深入分析，问题的根源在于我们选择了一个错误的架构：我们试图通过拦截Qt原生控件（`QPlainTextEdit`）的键盘事件，来**手动地、从零开始地重新实现一个文本编辑器的核心交互逻辑**。这条路线已被证明极其复杂、脆弱，且与Qt框架的设计哲学相冲突。

**2. 最终的想法 (The Solution):**
我们提出的最终解决方案是一次彻底的**架构范式迁移**，其核心是**“回归本源，最大化利用现有框架”**。
- **放弃手动处理输入**：我们不再拦截键盘事件，将所有复杂的底层编辑任务（输入、光标、选择、输入法等）**100%交还给Qt强大的原生引擎**。
- **拥抱被动响应**：我们的代码不再“主动”驱动视图，而是**被动地**监听`QPlainTextEdit`内部`QTextDocument`模型的`contentsChanged`信号。
- **简化流程**：当文本变化后，我们仅从信号中获取由Qt保证其正确性的**最终纯文本结果**，然后用这个结果去驱动我们后续的应用逻辑（如AST解析、UI更新等）。

这个方案能从根本上解决所有“怪异”的输入问题，极大地简化我们的代码库，并为未来实现所见即所得（WYSIWYG）功能奠定最坚实、最正确的基础。

---

## 1. 历史问题与根源反思

在V0.3的开发周期中，我们尝试了两种复杂的模型-视图同步方案（全量刷新、差分更新），但都遇到了大量难以解决的“怪异”输入问题（如Tab键、光标错位等）。

**根本原因：** 我们试图通过拦截并阻止 `QPlainTextEdit` 的原生输入行为，来手动地、从零开始地重新实现一个文本编辑器的核心交互逻辑。这相当于在重新发明一个已经被Qt框架高度优化的轮子，导致了不可避免的复杂性和脆弱性。

## 2. 终极解决方案：最大化利用Qt，最小化编写代码

为了从根本上解决所有底层编辑问题，并为未来的所见即所得（WYSIWYG）功能铺平道路，我们决定进行一次架构上的拨乱反正。

**核心思想：** 放弃我们自己维护的独立数据模型和复杂的输入处理逻辑。我们完全信赖并顺应Qt强大的文本处理框架，将 **`QPlainTextEdit` 内部的 `QTextDocument`** 视为我们应用程序中关于文本内容的**唯一的、真正的模型**。

**这个方案的本质是“不再从零实现编辑器”，而是“最大化地利用现成的编辑器”。**

## 3. 架构对比

### 3.1 错误的路线 (已被证明不可行)
我们拦截所有键盘事件，自己处理所有输入逻辑。

```mermaid
graph TD
    subgraph 错误的路线 (我们之前做的)
        A[用户按键] --> B{我们自己写的代码};
        B --> C[计算光标位置];
        B --> D[处理Tab键];
        B --> E[处理Backspace];
        B --> F[处理所有其他情况...];
        G[大量复杂的代码] --> H(更新我们的独立模型);
        H --> I(用diff同步到视图);
        J((出现大量'怪异'的Bug));
    end
```

### 3.2 正确的、极简的路线 (最终推荐方案)
我们不再拦截键盘事件，只在Qt完成工作后被动地接收结果。

```mermaid
graph TD
    subgraph 正确的、极简的路线 (推荐方案)
        A[用户按键] --> B[Qt QPlainTextEdit 的原生引擎];
        B -- (内部处理所有复杂逻辑) --> C(更新内部的QTextDocument);
        C -- (完成所有修改后) --> D[发出 contentsChanged 信号];
        D --> E{我们写的、唯一的槽函数};
        E -- (只获取最终的纯文本) --> F(更新我们的AST);
        F --> G(触发后续的渲染逻辑);
        H((所有输入问题都由Qt解决, 不再有'怪异'Bug));
    end
```

## 4. 新架构的优势

- **100%解决所有底层编辑问题**：所有复杂的编辑交互都由经过数十年工业级验证的Qt框架负责。
- **代码极大简化**：废弃了我们自定义的`Document`模型、`diff-match-patch`库以及所有复杂的输入拦截和同步逻辑。
- **与“AST+渲染”目标完全兼容**：此方案专注于解决“如何安全地获取用户输入”这一难题，使我们能真正聚焦于AST处理和自定义渲染的核心目标。
- **纯Python方案**：完全在PySide6/Qt框架内，不依赖任何Web技术。

## 5. 实施计划

- **废弃**: `core/document.py`, `core/constants.py` 和相关的单元测试 `tests/test_document.py`。
- **重构**: `plugins/editable_editor/main.py` 将被彻底重写，以遵循上述新的、更简单的工作流。